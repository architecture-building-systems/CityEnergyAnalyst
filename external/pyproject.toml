[project]
name = "cea-external-tools"
description = "External tools for City Energy Analyst, mainly containing C++ components e.g. DAYSIM and CRAX"
readme = "README.md"
requires-python = "<3.13,>=3.8"
authors = [
    { name = "Reynold Mok", email = "reynold.mok@arch.ethz.ch" }
]
dynamic = [ "version" ]

[project.urls]
"Homepage" = "https://cityenergyanalyst.com"
"Bug Reports" = "https://github.com/architecture-building-systems/CityEnergyAnalyst/issues"
"Source" = "https://github.com/architecture-building-systems/CityEnergyAnalyst"

[build-system]
requires = ["scikit-build-core>=0.11.0"]
build-backend = "scikit_build_core.build"

[tool.scikit-build]
# Only install the cea_targets component (manually defined in our CMakeLists.txt)
install.components = ["cea_targets", "crax_targets"]
wheel.packages = ["cea_external_tools"]
# Set persistent build directory for caching
build-dir = "build"

[tool.scikit-build.metadata.version]
provider = "scikit_build_core.metadata.regex"
input = "cea_external_tools/__init__.py"

[tool.scikit-build.build]
# Only build the cea_targets target, not all targets (avoids unwanted programs)
targets = ["cea_all"]
# Verbose output for debugging
verbose = false

[tool.scikit-build.cmake]
# Build in Release mode for performance
build-type = "Release"
# Define CMake variables that control installation paths
define = {INSTALL_BIN_DIR = "cea_external_tools/bin"}

[tool.pixi.workspace]
channels = ["conda-forge"]
platforms = [
    "linux-64", "linux-aarch64",
    "osx-64", "osx-arm64",
    "win-64"
]

[tool.pixi.tasks]
setup-dev = {cmd = "CMAKE_BUILD_PARALLEL_LEVEL=4 uv pip install -ve . --group dev --no-build-isolation"}
build-wheel = {cmd = "CMAKE_BUILD_PARALLEL_LEVEL=4 uv build"}

[tool.pixi.dependencies]
# For arrow headers files
pyarrow = "==21.0.0"

# Development tools
scikit-build-core = ">=0.11.0"
cmake = ">=3.15" # Minimum required version for builds
uv = "*"

[tool.pixi.environments]
docker-build-wheel = ["docker-build-wheel"]

[tool.pixi.feature.docker-build-wheel.dependencies]
# Dependencies for building wheels in Docker
git = "*"
cxx-compiler = "*"

[tool.pixi.feature.docker-build-wheel.tasks]
# Add suppression flag for warnings treated as error during build
docker-build-wheel = "CXXFLAGS='-Wno-error=maybe-uninitialized ${CXXFLAGS}' pixi run build-wheel && pixi clean"
